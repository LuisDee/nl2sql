# Track Brief: Few-Shot Example Expansion

> Generated by Architect based on Best Practice Alignment Plan (Part 4)

## What This Track Delivers
This track expands the validated Q→SQL example set from the current 54 examples to 150+ examples, covering critical gaps identified in the codebase research: JOINs (currently 2), interval decomposition patterns (currently 9), exchange-specific queries (currently 0), categorical filtering, aggregation patterns, and edge cases.

## Source Requirements
- **Part 4 — Few-Shot Example Expansion:**
  - Target: 150+ validated examples across all 12 tables
  - Coverage gaps to fill:
    - **JOINs:** Cross-dataset joins (KPI↔data), self-joins, multi-table queries (currently only 2)
    - **Interval decomposition:** More slippage/delta patterns at different intervals (1s, 10m, 1h)
    - **Exchange-specific:** Queries filtered by exchange using `resolve_exchange` patterns (currently 0)
    - **Categorical filtering:** Queries using `portfolio`, `symbol`, `term`, `instrument_type` with realistic values
    - **Aggregation patterns:** GROUP BY with HAVING, window functions, PARTITION BY
    - **Time patterns:** `trade_date` filtering, TIMESTAMP_TRUNC, date ranges, relative dates ("last week")
    - **Edge cases:** NULL handling, empty results, ambiguous questions, multi-step reasoning
  - All examples must pass `dry_run_sql` validation against dev BQ
  - All column references must exist in the YAML catalog (enforced by `test_example_column_validation.py`)

## Cross-Cutting Constraints
- **Column validation:** Every example must pass `test_all_example_columns_exist_in_catalog` (Track 17's validation test)
- **No double-counting:** Never combine `markettrade` with Mako-specific tables (`quotertrade`, `brokertrade`, `clicktrade`, `otoswing`) in UNION ALL
- **Correct column names:** Use `instant_edge` not `edge`, `bid_volume_0` not `bid_size_0`, `option_type_name` not `putcall`
- **{project} placeholder:** All fully-qualified table names use `{project}` placeholder
- **BQ dry-run:** Every example SQL must pass dry-run validation (catches syntax errors and nonexistent columns)

## Interface Contracts
- **Owned:**
  - `expanded_examples` — 150+ Q→SQL examples in `examples/{kpi,data,routing}_examples.yaml`
- **Consumed:**
  - `yaml_catalog` — column names and descriptions for reference
  - `query_memory` — existing BQ query_memory table (examples get embedded here via `save_validated_query`)
  - `bigquery` — dry-run validation of all new examples

## Key Design Decisions
1. **Structured coverage matrix:** Create a coverage matrix (table × pattern × complexity) to ensure systematic expansion rather than ad-hoc addition.
2. **Batch validation:** New script `scripts/validate_examples.py` runs dry-run on all examples in one pass, reporting failures.
3. **Example categorization:** Each example gets a `category` tag (join, aggregation, filter, time, exchange, edge_case) for coverage tracking.
4. **Incremental addition:** Add examples in batches (Phase 1: categorical/filter, Phase 2: JOINs/aggregation, Phase 3: exchange/time, Phase 4: edge cases), validating each batch before proceeding.

## Test Strategy
- **Unit:** All existing `test_example_column_validation.py` tests pass with expanded examples
- **Integration:** `scripts/validate_examples.py --dry-run` passes for all 150+ examples
- **Coverage:** Coverage matrix shows >80% cell coverage (table × pattern combinations)
- **Regression:** Eval set accuracy does not decrease after example expansion

## Complexity: Medium
## Estimated Phases: 4
