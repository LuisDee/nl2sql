<!-- generated by autopsy -->
# Unit Tests

## Purpose
Unit test suite for the NL2SQL agent. Tests all core modules (config, protocols, callbacks, tools, prompts, serialization, catalog loader) using mock BQ services. Env vars are set at module level in conftest.py because Settings() singleton initializes at import time.

## Key Files
| File | Purpose | Key Exports |
|------|---------|-------------|
| conftest.py | Module-level env vars, MockBigQueryService, mock_bq fixture | `MockBigQueryService`, `mock_bq` |
| fakes.py | FakeBigQueryClient and FakeEmbeddingClient for protocol testing | `FakeBigQueryClient`, `FakeEmbeddingClient` |
| test_callbacks.py | Tests DML guard, retry tracking, circuit breaker, repetition detection | 7 tests |
| test_vector_search.py | Tests vector_search_tables and fetch_few_shot_examples | 4 tests |
| test_combined_vector_search.py | Tests combined CTE search and cache behavior | 6 tests |
| test_serialization.py | Tests sanitize_value for BQ types (Timestamp, Decimal, NaT, numpy) | 5+ tests |
| test_yaml_catalog.py | Validates all 15 YAML catalog files parse and have required keys | parametrized |
| test_prompts.py | Tests build_nl2sql_instruction with session state context | 5 tests |
| test_eval_runner.py | Tests EvalRunner offline mode, component match, routing check | 6 tests |

## Data Flow
Test -> conftest.py sets env vars -> MockBigQueryService injected via mock_bq -> tool under test -> assertions

## Dependencies
- Internal: nl2sql_agent package (all modules under test)
- External: pytest, pytest-asyncio, pandas

## Patterns & Conventions
- conftest.py sets env vars at MODULE LEVEL (lines 12-26) before any fixture runs
- MockBigQueryService uses keyword-based response matching (set_query_response)
- mock_bq fixture injects mock into tools._deps and clears vector cache on teardown

## Gotchas
- Env vars MUST be set before importing nl2sql_agent (Settings singleton at import time)
- FakeBigQueryClient.query_with_params returns list[dict]; execute_query returns DataFrame
- Integration tests in tests/integration/ have a separate conftest that overrides set_test_env

## Testing
- Run: `pytest tests/ -v` (excludes integration by default via addopts)
- Framework: pytest with pytest-asyncio (asyncio_mode = "auto")

## Boundaries
- **Always:** use MockBigQueryService or FakeBigQueryClient, never real BQ in unit tests
- **Ask first:** adding new env vars to _TEST_ENV in conftest.py
- **Never:** depend on real .env file or live services in unit tests

## Recent Changes
- 2026-02-20: Initial documentation generated by autopsy
