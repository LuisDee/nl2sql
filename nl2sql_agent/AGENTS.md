<!-- generated by autopsy -->
# nl2sql_agent Package

## Purpose
Main Python package for the NL2SQL agent. Defines the ADK agent hierarchy (root_agent delegates to nl2sql_agent), configuration via pydantic-settings, protocol-based dependency injection for BigQuery/embedding services, prompt engineering, and ADK callbacks for guardrails and state management.

## Key Files
| File | Purpose | Key Exports |
|------|---------|-------------|
| agent.py | ADK agent definitions, tool wiring, model init | `root_agent`, `nl2sql_agent` |
| config.py | pydantic-settings Settings class, .env loading | `settings` (singleton) |
| protocols.py | Protocol interfaces for BQ and embedding services | `BigQueryProtocol`, `EmbeddingProtocol` |
| clients.py | Concrete BQ client using google-cloud-bigquery | `LiveBigQueryClient` |
| prompts.py | Dynamic system prompt builder with routing rules | `build_nl2sql_instruction` |
| callbacks.py | before/after tool callbacks: DML guard, retry tracking, loop detection | `before_tool_guard`, `after_tool_log` |
| catalog_loader.py | YAML catalog loading, validation, and caching (lru_cache) | `load_yaml`, `load_all_table_yamls`, `validate_table_yaml` |
| serialization.py | JSON-safe conversion for BQ types (Timestamp, Decimal, NaT) | `sanitize_rows`, `sanitize_value` |
| logging_config.py | structlog JSON logging setup | `setup_logging`, `get_logger` |
| __init__.py | Re-exports agent module for ADK discovery | - |

## Data Flow
User question -> root_agent (delegation) -> nl2sql_agent (7 tools in sequence) -> BigQuery -> formatted response

## Dependencies
- Internal: tools/ (all agent tools), catalog/ (YAML files)
- External: google-adk, google-cloud-bigquery, litellm, pydantic-settings, structlog, pyyaml

## Patterns & Conventions
- Settings singleton created at module import time (config.py line 114)
- Protocol-based DI: all BQ access through BigQueryProtocol
- Callbacks use ToolContext.state for retry tracking and session persistence

## Configuration
- `nl2sql_agent/.env` loaded via pydantic-settings (absolute path resolution from config.py)
- Key env vars: LITELLM_API_KEY, LITELLM_API_BASE, GCP_PROJECT, BQ_LOCATION, *_DATASET

## Gotchas
- Settings() runs at import time, so env vars must be set BEFORE importing nl2sql_agent
- agent.py creates LiveBigQueryClient at module scope -- import triggers BQ client init
- callbacks.py uses MD5 hash for repetition detection (not cryptographic, just dedup)
- serialization.py must handle pd.NaT before datetime check (NaT is a datetime instance)

## Testing
- Tests: tests/test_agent_init.py, test_callbacks.py, test_config.py, test_prompts.py, etc.
- Run: `pytest tests/ -v`
- Gaps: No direct test for agent.py module-level initialization side effects

## Boundaries
- **Always:** use protocols not concrete clients, sanitize BQ results before returning
- **Ask first:** changes to Settings fields or prompt routing rules
- **Never:** import agent.py in tests without mocking env vars first

## Recent Changes
- 2026-02-20: Initial documentation generated by autopsy
