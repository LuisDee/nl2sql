# System Architecture

> Generated by `/architect-decompose` on 2026-02-18
> Based on: conductor/product.md, conductor/tech-stack.md, initial-plan.md

---

## System Overview

This project implements a specialized Natural Language to SQL (NL2SQL) agent for Mako Group's trading desk. It functions as a **sub-agent** (`nl2sql_agent`) under a root Gemini conversational assistant. The root agent handles greetings and delegation, while the NL2SQL agent owns the full data pipeline: routing questions to the correct dataset (Volbox vs KPI), retrieving schema metadata, generating BigQuery SQL, validating it via dry-runs, and executing it safely.

The system relies on a **Two-Layer Metadata Strategy**:
1.  **Layer 1 (Human):** YAML catalog files defining tables, columns, synonyms, and business rules.
2.  **Layer 2 (AI):** BigQuery Vector Search embeddings of the catalog and validated few-shot examples for semantic retrieval.

---

## Component Map

```
┌─────────────────────────┐
│  Root Agent (Gemini)    │
│  (Orchestrator)         │
└────────────┬────────────┘
             │ "Show me PnL..." (Delegation)
             ▼
┌─────────────────────────────────────────────────────────┐
│  NL2SQL Sub-Agent (LlmAgent)                            │
│                                                         │
│  ┌─────────────────┐    ┌────────────────────────────┐  │
│  │  Tools Layer    │◀──▶│      Context Layer         │  │
│  │                 │    │                            │  │
│  │ - vector_search │    │ 1. YAML Catalog (Code)     │  │
│  │ - load_metadata │    │ 2. Embeddings (BigQuery)   │  │
│  │ - generate_sql  │    │    - schema_embeddings     │  │
│  │ - dry_run_sql   │    │    - query_memory          │  │
│  │ - execute_sql   │    │                            │  │
│  └────────┬────────┘    └────────────────────────────┘  │
│           │                                             │
└───────────┼─────────────────────────────────────────────┘
            │ SQL
            ▼
┌──────────────────────┐
│       BigQuery       │
│ (Dev/Prod Datasets)  │
└──────────────────────┘
```

---

## Technology Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Agent Framework** | Google ADK | Native `LlmAgent` support for sub-agent delegation and tool use. |
| **Vector Database** | BigQuery Vector Search | Keeps data and embeddings in the same place; allows `VECTOR_SEARCH` directly in SQL tools. |
| **Metadata Source** | YAML + Git | Version-controlled source of truth. easier for humans to edit than a DB UI. |
| **SQL Validation** | BigQuery Dry-Run | Zero-cost way to catch syntax/permission errors before execution. |

---

## Architecture Decision Records

### ADR-001: Separation of Root and Sub-Agent

- **Status:** Accepted
- **Context:** Traders need a single interface but the data pipeline is complex.
- **Decision:** Use a **Root Agent** for intent classification and a dedicated **NL2SQL Sub-Agent** for data tasks.
- **Consequences:**
    - (+) Clean separation of concerns (chat vs. query).
    - (+) Sub-agent prompt can be highly specialized for SQL without distraction.
    - (+) Root agent can handle other future domains (Compliance, Risk) by adding more sub-agents.

### ADR-002: BigQuery-Native Embeddings

- **Status:** Accepted
- **Context:** We need semantic search for tables and few-shot examples.
- **Decision:** Use **BigQuery Vector Search** (`VECTOR_SEARCH` function) instead of a separate vector DB (Pinecone/Weaviate).
- **Consequences:**
    - (+) Simplifies infra (no new service).
    - (+) Atomic updates (metadata and embeddings live together).
    - (+) Agent tools just run SQL queries to find context.

---

## Accepted Architecture Patterns

| Pattern | Tier | Rationale |
|---------|------|-----------|
| **Retry with Exponential Backoff** | Strongly Recommended | For Vertex AI generation and BigQuery API calls. |
| **Structured Logging** | Strongly Recommended | Essential for tracing the `Root -> Sub-Agent -> Tool` delegation flow. |
| **Input Validation** | Strongly Recommended | Pydantic models for all tool arguments. |

---

## Deferred Pattern Triggers

| Pattern | Trigger Condition | Discovery Classification |
|---------|-------------------|--------------------------|
| **Semantic Caching** | Latency > 5s for repeated queries | NEW_TRACK (Optimization) |
| **LoopAgent (Auto-Correction)** | Dry-run failure rate > 10% | ARCHITECTURE_CHANGE |
