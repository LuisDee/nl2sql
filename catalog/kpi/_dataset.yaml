dataset:
  name: "{kpi_dataset}"
  layer: kpi
  description: >
    KPI (Key Performance Indicators) for OMX options trading. Gold layer.
    Contains one table per trade origin, all sharing the same KPI column structure.
    Each row represents one trade with computed performance metrics:
    instant_edge, instant_pnl, instant_pnl_w_fees, delta_slippage at multiple intervals.

  tables:
    - brokertrade
    - clicktrade
    - markettrade
    - otoswing
    - quotertrade

  trade_taxonomy:
    description: >
      CRITICAL: markettrade contains ALL market trades across all participants â€” it is
      the superset. The other 4 tables (quotertrade, brokertrade, clicktrade, otoswing)
      contain only Mako's own trades, which ALSO appear in markettrade. When aggregating
      "total PnL across all trade types", you MUST NOT sum markettrade + the others
      because that double-counts Mako's trades. Either use markettrade alone (all trades)
      or UNION the 4 Mako-specific tables (quotertrade, brokertrade, clicktrade, otoswing)
      for Mako-only totals.
    markettrade: "All market trades from all participants (Mako + counterparties). Superset."
    quotertrade: "Mako's auto-quoter fills only. Subset of markettrade."
    brokertrade: "Mako's broker-facilitated (voice/OTC) trades only. Subset of markettrade."
    clicktrade: "Mako's manual screen/click trades only. Subset of markettrade."
    otoswing: "Mako's automated OTO swing takeouts only. Subset of markettrade."

  shared_columns:
    trade_date:
      description: >
        Date of the trade. This is the partition column on every KPI table and must
        always appear in a WHERE clause to avoid full table scans. Format is DATE
        (YYYY-MM-DD). When traders say "yesterday" or "last week", resolve to the
        appropriate date range and filter on trade_date. Never omit this filter.
      synonyms: ["date", "trading date"]
    portfolio:
      description: >
        Trading portfolio identifier. Each portfolio represents a distinct trading
        strategy or desk within the firm. Common values include MON, WHITE, RED,
        BROADWAY, FIXEDINCOME_US, US_D1_OPT, AMM_OIL, FIPROP_US, EURODOLLARS,
        STOCKS_EUR, STOCKS_EUR2, STOCKS_EUR4, INDEXPROP, EUPOWER. Used to segment
        performance by strategy.
      synonyms: ["book", "portfolio name"]
      example_values: ["MON", "WHITE", "RED", "BROADWAY", "FIXEDINCOME_US", "US_D1_OPT", "AMM_OIL", "FIPROP_US", "EURODOLLARS", "STOCKS_EUR", "STOCKS_EUR2", "STOCKS_EUR4", "INDEXPROP", "EUPOWER"]
    symbol:
      description: >
        Underlying instrument symbol (e.g. AAPL, TSLA, SPX). This identifies the
        root product the option is written on. Traders may refer to it as the
        "underlying", "ticker", or "product". Use this column when filtering by
        instrument name or grouping performance by product.
      synonyms: ["underlying", "ticker", "product"]
    term:
      description: >
        Option expiry or term label. Identifies which expiration cycle the option
        belongs to (e.g. "Mar25", "Jun25"). Traders often say "expiry", "expiration",
        or "maturity". Use this to filter or group trades by option term. Format is
        typically a short month-year string.
      synonyms: ["expiry", "expiration", "maturity"]
    instrument_hash:
      description: >
        Unique hash identifying the specific option contract. This is a deterministic
        hash of the contract's key attributes (symbol, strike, term, put/call). Use it
        to join across tables or to identify exact contracts. Traders rarely reference
        this directly but it is essential for precise contract-level queries.
      synonyms: ["contract id", "instrument id"]
    instant_edge:
      description: >
        Instantaneous edge (theoretical profit per unit) at the moment of trade
        execution. Positive = traded better than fair value (captured edge),
        negative = traded worse. This is the primary performance metric traders
        care about. Always present on every KPI row.
      synonyms: ["edge", "the edge", "how much edge", "trading edge", "edge_bps"]
    instant_pnl:
      description: >
        Immediate profit or loss from the trade at execution time, measured in the
        trade's native currency. This represents the mark-to-market PnL at the instant
        of execution, before any subsequent market moves. Positive = profitable trade,
        negative = loss. Commonly aggregated via SUM to get total PnL for a period,
        portfolio, or symbol.
      synonyms: ["PnL", "instant PnL", "profit", "loss", "P&L", "pnl"]
    instant_pnl_w_fees:
      description: >
        Instant PnL with fees deducted. Same as instant_pnl but after subtracting
        exchange fees and clearing costs. Present on every KPI row.
      synonyms: ["pnl with fees", "net pnl", "pnl after fees"]

  enum_reference:
    trade_side:
      description: "Direction of the trade"
      values: ["BUY", "SELL"]
      raw_codes: {"66": "BUY", "83": "SELL", "0": "UNKNOWN", "88": "NULL_BUYSELL"}
      alternate_labels: ["BUYSELL_BUY", "BUYSELL_SELL"]
    portfolio:
      description: "Trading portfolio / strategy desk"
      values: ["MON", "WHITE", "RED", "BROADWAY", "FIXEDINCOME_US", "US_D1_OPT", "AMM_OIL", "FIPROP_US", "EURODOLLARS", "STOCKS_EUR", "STOCKS_EUR2", "STOCKS_EUR4", "INDEXPROP", "EUPOWER"]
    algorithm:
      description: "Algorithm or execution strategy that originated the trade"
      values: ["OST_MQ", "OST_X", "ZB_TAK"]
      notes: "OST_MQ = Quoter, OST_X = Korea Market, ZB_TAK = Taker"

  interval_expansion:
    description: >
      All KPI tables share a standard set of time-bucketed slippage columns. For each
      interval, a family of slippage decomposition columns is generated (e.g.
      delta_slippage_1s, delta_slippage_5s, ..., delta_slippage_1h).
    intraday_intervals: ["1s", "5s", "10s", "30s", "1m", "5m", "10m", "30m", "1h"]
    multiday_intervals:
      standard: ["1D", "5D"]
      ice_arb_only: ["10D", "20D", "50D", "80D"]
    column_families:
      - adjusted_tv
      - tv_change
      - tv_change_buysell
      - delta_slippage
      - delta_slippage_per_unit
      - roll_slippage
      - roll_slippage_per_unit
      - vol_slippage
      - vol_slippage_per_unit
      - other_slippage
      - other_slippage_per_unit
      - vol_path_estimate
      - total_slippage
    table_specific:
      brokertrade: ["tv_offset_slippage", "tv_offset_slippage_per_unit"]
      otoswing: ["delta_slippage_fired_at", "roll_slippage_fired_at", "vol_slippage_fired_at", "other_slippage_fired_at"]

  combo_logic:
    description: >
      KPI tables can contain combo (multi-leg) trades. The kpi_combos.sql pipeline
      aggregates individual leg rows (is_parent=False) into parent combo rows
      (is_parent=True). When querying combo trades, filter on is_parent=True to get
      the aggregated view, or is_parent=False to see individual legs.
    parent_indicator: "is_parent"
    summed_columns: ["tv", "delta", "gamma", "vega", "theta", "rho", "all slippage PnL columns"]
    averaged_columns: ["under"]
    notes: >
      The parent row replaces its original values with the summed leg values.
      When traders ask about combo performance, default to is_parent=True unless
      they specifically want leg-level detail.

  routing:
    - patterns: ["market trade", "exchange trade", "generic trades"]
      table: markettrade
      notes: "Default KPI table when trade type is unspecified"

    - patterns: ["quoter trade", "quoter fill", "quoter PnL", "quoter edge", "auto-quoter"]
      table: quotertrade
      notes: "KPI metrics for auto-quoter originated fills. NOT raw quoter activity."

    - patterns: ["broker trade", "voice trade", "BGC", "MGN", "account", "broker performance"]
      table: brokertrade
      notes: "Has account/broker fields. Use when comparing broker performance. NOTE: may be empty for some dates."

    - patterns: ["click trade", "manual trade"]
      table: clicktrade

    - patterns: ["OTO", "swing", "otoswing", "OTO swing"]
      table: otoswing

    - patterns: ["all trades", "total PnL", "overall", "across all types", "every trade type"]
      table: markettrade
      notes: "markettrade is the superset containing ALL participants' trades. Do NOT UNION ALL with Mako-specific tables (double-counts)."

    - patterns: ["by trade type", "by Mako trade type", "quoter vs click vs broker", "compare trade types"]
      action: "UNION ALL across quotertrade, brokertrade, clicktrade, otoswing (4 Mako-only tables)"
      notes: "Excludes markettrade to avoid double-counting. These 4 are Mako-only subsets."

  disambiguation:
    kpi_vs_data_same_table_name: >
      Both {kpi_dataset} and {data_dataset} contain tables with the same names
      (brokertrade, clicktrade, markettrade, quotertrade). The KPI dataset has
      enriched performance metrics (instant_edge, instant_pnl, slippage decomposition).
      The data dataset has raw trade execution details (exact timestamps, prices,
      sizes, fill information). If the question is about performance, edge, PnL,
      or slippage, use KPI. If the question is about raw execution details, timestamps,
      or exact fill prices, use data.
