<!-- generated by autopsy -->
# YAML Metadata Catalog

## Purpose
Two-layer metadata system: static YAML catalog (this directory) describing every dataset, table, column, synonym, and routing rule for BigQuery tables. Serves as the human-editable source of truth that powers the agent's semantic search and SQL generation context.

## Key Files
| File | Purpose | Key Exports |
|------|---------|-------------|
| _routing.yaml | Cross-dataset disambiguation rules, enum references, interval expansion docs | YAML routing descriptions |
| README.md | Full documentation: how to add tables, run embeddings, switch environments | - |
| kpi/_dataset.yaml | KPI dataset description, shared columns, routing patterns | YAML dataset metadata |
| kpi/*.yaml | Per-table YAML: 5 KPI tables (markettrade, quotertrade, brokertrade, clicktrade, otoswing) | YAML table metadata |
| data/_dataset.yaml | Data dataset description, routing patterns | YAML dataset metadata |
| data/*.yaml | Per-table YAML: 7 data tables (theodata, marketdata, marketdepth, etc.) | YAML table metadata |

## Data Flow
YAML files -> catalog_loader.py (load/validate) -> metadata_loader tool (serve to LLM) -> also -> populate_embeddings.py -> BQ embedding tables

## Dependencies
- Internal: Consumed by nl2sql_agent/catalog_loader.py, scripts/populate_embeddings.py
- External: None (static YAML files)

## Patterns & Conventions
- All FQN fields use `{project}` placeholder (never hardcoded project IDs)
- Required table keys: name, dataset, fqn, layer, description, partition_field, columns
- Required column keys: name, type, description; optional: synonyms, example_values
- Files prefixed with _ are dataset-level context, not individual tables
- KPI tables are large (200-376KB each) due to extensive slippage interval columns

## Gotchas
- KPI table YAMLs have hundreds of columns (slippage at 9+ intervals x multiple metrics)
- _routing.yaml contains critical disambiguation logic -- changes affect all query routing
- enrichment/ subdirectory exists but is empty (placeholder for future enrichment metadata)
- Tables with same names exist in both datasets (markettrade, quotertrade, clicktrade)

## Testing
- Tests: tests/test_yaml_catalog.py (validates all 15 files), tests/test_catalog_loader.py
- Run: `pytest tests/test_yaml_catalog.py tests/test_catalog_loader.py -v`

## Boundaries
- **Always:** use {project} placeholder, include all required keys, update _dataset.yaml when adding tables
- **Ask first:** changes to _routing.yaml (affects agent routing accuracy)
- **Never:** hardcode project IDs, remove columns without checking dependent queries

## Recent Changes
- 2026-02-20: Initial documentation generated by autopsy
