# Track Brief: Agent Logic (Phase D)

> Generated by Architect based on `initial-plan.md`

## What This Track Delivers
This track defines the **Agent Logic** and **System Prompt** for the NL2SQL sub-agent. It implements the specific routing rules (KPI vs Quoter vs Theo), the BigQuery SQL dialect enforcement, and the retry/clarification behavior. It includes rigorous end-to-end testing of 5 core request types.

## Source Requirements (from initial-plan.md)
- **D.1 NL2SQL Prompt:** Write comprehensive system prompt with:
    - Tool execution order (Search -> Meta -> Ex -> Gen -> Dry -> Exec).
    - Routing rules (Broker -> kpi_brokertrade, Quoter -> kpi_quotertrade vs quoter_quotertrade).
    - SQL dialect rules (Standard SQL, date partitions).
- **D.2 Root Prompt:** Refine delegation logic (`mako_assistant`).
- **D.3 End-to-End Testing:** Verify 5 request types: Theo (Req #1), Quoter Activity (Req #2), Performance (Req #5), Routing (Broker/Quoter), Unions ("all trades").

## Cross-Cutting Constraints
- **Routing Accuracy:** Must correctly disambiguate "quoter trade" (KPI) vs "quoter activity" (Raw).
- **Clarification:** Agent must ask clarifying questions if ambiguous (e.g., "Which expiry?").

## Interface Contracts
- **Owned:** `Agent Logic` (System Prompt)
- **Consumed:** `All Tools` (from Track 03)

## Key Design Decisions
1.  **Prompt Strategy:** Single prompt or multi-stage? -> **Single** comprehensive prompt for MVP (simpler context management).
2.  **Routing Rules:** Hardcoded in prompt or embedded? -> **Both**. Hardcoded for critical rules ("broker" -> kpi_brokertrade), embedded for nuance.

## Test Strategy
- **Manual (High ROI):** Run `adk web agent/` and verify the 5 core scenarios.
- **Trace Analysis:** Verify tool calls happen in the correct order.

## Complexity: Medium
## Estimated Phases: 3
