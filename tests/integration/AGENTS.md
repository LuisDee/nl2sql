<!-- generated by autopsy -->
# Integration Tests

## Purpose
Integration tests that require live BigQuery and LiteLLM proxy. Automatically marked with `@pytest.mark.integration` via pytest_collection_modifyitems hook. Tests end-to-end agent behavior, tool chains, retry loops, semantic cache, and LiteLLM connectivity.

## Key Files
| File | Purpose | Key Exports |
|------|---------|-------------|
| conftest.py | Real .env loading, real_settings, bq_client, litellm_base_url fixtures | `real_settings`, `bq_client` |
| test_agent_e2e.py | End-to-end agent question answering | 2 tests |
| test_bigquery.py | BQ connectivity and dry_run smoke test | 1 test |
| test_litellm_proxy.py | LiteLLM proxy health, model list, completions | 4 tests |
| test_tool_chain.py | Multi-tool sequence: vector_search -> metadata -> dry_run -> execute | 4 tests |
| test_retry_loop.py | Retry and circuit breaker behavior with real services | 2 tests |
| test_semantic_cache.py | Semantic cache hit/miss with real embeddings | 3 tests |
| test_adk_eval.py | ADK evaluation framework test with routing_eval.test.json | 2 tests |
| test_eval_gold_set.py | Validates gold query set structure via validate_gold_set | 1 test |

## Data Flow
Test -> conftest loads real .env -> creates LiveBigQueryClient -> runs against live BQ/LiteLLM -> assertions

## Dependencies
- Internal: nl2sql_agent package, eval package
- External: Live BigQuery, Live LiteLLM proxy, Google ADC

## Patterns & Conventions
- conftest.py overrides parent's autouse set_test_env with a no-op (line 28-33)
- real_settings fixture uses dotenv_values + os.environ injection for clean loading
- bq_client fixture skips if auth fails (catches credential errors gracefully)
- litellm_base_url translates host.docker.internal -> localhost for host-side testing

## Gotchas
- These tests WILL FAIL without valid GCP credentials and running LiteLLM proxy
- real_settings is session-scoped: env restoration happens once after all integration tests
- Parent conftest env vars (test-key-not-real) must NOT leak into integration tests

## Testing
- Run: `pytest -m integration tests/integration/ -v`
- Excluded from default run via `addopts = "-m 'not integration'"` in pyproject.toml

## Boundaries
- **Always:** skip gracefully if services unavailable (pytest.skip)
- **Ask first:** adding tests that modify BQ data (DML)
- **Never:** run integration tests in CI without proper credentials setup

## Recent Changes
- 2026-02-20: Initial documentation generated by autopsy
