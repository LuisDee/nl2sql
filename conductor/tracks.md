# Project Tracks

> Generated by Architect. 17 tracks across 16 waves.
> Run /conductor:implement to begin.

---

## [x] Track: Context Layer (Phase B)
- **ID:** 02_context_layer
- **Wave:** 2
- **Complexity:** L
- **Dependencies:** 01_foundation

---

## [x] Track: Agent Tools (Phase C)
- **ID:** 03_agent_tools
- **Wave:** 3
- **Complexity:** M
- **Dependencies:** 02_context_layer

---

## [x] Track: Agent Logic (Phase D)
- **ID:** 04_agent_logic
- **Wave:** 4
- **Complexity:** M
- **Dependencies:** 03_agent_tools

---

## [x] Track: Eval & Hardening (Phase E/F)
- **ID:** 05_eval_hardening
- **Wave:** 5
- **Complexity:** L
- **Dependencies:** 04_agent_logic

---

## [x] Track: Metadata Enrichment
- **ID:** 06_metadata_enrichment
- **Wave:** 3
- **Complexity:** L
- **Dependencies:** 02_context_layer
- **Notes:** Can run in parallel with Track 04. Enriches YAML catalog + BQ embeddings from kpi-findings and proto-findings source files.

---

## [x] Track: Fix Missing DB Dependencies
- **ID:** 07_dependency_fix
- **Wave:** 1
- **Complexity:** S
- **Dependencies:** []
- **Description:** Adds db-dtypes to resolve runtime errors in execute_sql tool when handling timestamps.

---

## [x] Track: Loop Fix & Performance Optimization
- **ID:** 08_loop_and_performance_fix
- **Wave:** 6
- **Complexity:** M
- **Dependencies:** 04_agent_logic, 05_eval_hardening
- **Description:** Fixes infinite reasoning loops and optimizes performance by reducing LLM round-trips and context size.

---

## [x] Track: Production Hardening (Serialization + Smart Loop Prevention)
- **ID:** 09_production_hardening
- **Wave:** 7
- **Complexity:** M
- **Dependencies:** 08_loop_and_performance_fix
- **Description:** Fixes JSON serialization crash for BQ Timestamp/Date/Decimal types and replaces blunt tool call counter with hash-based repetition detection.

---

## [x] Track: Metadata Gaps (Trade Taxonomy + Preferred Timestamps)
- **ID:** 10_metadata_gaps
- **Wave:** 8
- **Complexity:** M
- **Dependencies:** 09_production_hardening, 06_metadata_enrichment
- **Description:** Adds trade type taxonomy, preferred timestamp columns, and ATM strike resolution patterns to YAML catalog metadata.

---

## [x] Track: Gemini CLI Integration (MCP Server)
- **ID:** 11_gemini_cli_mcp
- **Wave:** 9
- **Complexity:** M
- **Dependencies:** 09_production_hardening
- **Description:** Exposes the NL2SQL agent as an MCP server with a single `ask_trading_data` tool. Gemini CLI connects via stdio transport. Includes Level 2 progress notifications.

---

## [x] Track: Column-Level Semantic Search (Two-Tier Retrieval)
- **ID:** 12_column_semantic_search
- **Wave:** 10
- **Complexity:** L
- **Dependencies:** 09_production_hardening, 10_metadata_gaps
- **Description:** Adds column-level vector search to replace table-description-only routing. Single BQ query searches 4,631 column embeddings, aggregates to tables, returns top columns per table. Fixes phantom `edge_bps` column. Based on RESQL/TailorSQL/bidirectional retrieval research (2025).

---

## [x] Track: Multi-Exchange Support
- **ID:** 14_multi_exchange
- **Wave:** 11
- **Complexity:** M
- **Dependencies:** 12_column_semantic_search
- **Description:** Adds multi-exchange routing via alias/symbol lookup. Exchange registry YAML + resolve_exchange tool (3-tier: alias→symbol→default). Updates prompt with exchange-aware section. Parameterizes run_embeddings.py dataset names. Symbol-to-exchange BQ table from 4,806-row CSV. No changes to shared embeddings or vector search (research-backed: identical schemas = shared semantics).

---

## [x] Track: Autopsy Fixes
- **ID:** 13_autopsy_fixes
- **Wave:** 11
- **Complexity:** L
- **Dependencies:** 12_column_semantic_search
- **Description:** Fixes 10 critical and 20 high-severity findings from the autopsy deep review. Phase 1: ARRAY_LENGTH(NULL) bug, circuit breaker reset, example column names, PnL routing, query timeout, LIMIT detection, vector search CTE, destructive DDL. Phase 2: shared SQL guard, YAML auto-discovery, Docker fixes, lazy BQ init. Phase 3: online eval fix, ADK eval expansion, autonomous embeddings.

---

## [x] Track: Code Quality & Reliability
- **ID:** 15_code_quality
- **Wave:** 12
- **Complexity:** M
- **Dependencies:** 14_multi_exchange
- **Description:** Addresses findings from the codebase review NOT covered by Track 13. Phase 1: exchange-aware semantic cache (prevents cross-exchange pollution). Phase 2: TypedDict return contracts for all 8 tools. Phase 3: prompt caching, config documentation, .env.example. Phase 4: dead code cleanup, thread safety docs, error handling consolidation.

---

## [x] Track: Repo Scaffolding & Local CI
- **ID:** 16_repo_scaffolding
- **Wave:** 13
- **Complexity:** M
- **Dependencies:** 13_autopsy_fixes, 15_code_quality
- **Description:** Adds all missing Python tooling infrastructure. Phase 1: ruff lint/format + mypy type-check config. Phase 2: pre-commit hooks (ruff, gitleaks, file checks). Phase 3: GitHub Actions CI workflow + local `act` runner in Docker. Phase 4: Makefile with standard targets. Phase 5: root cleanup, README upgrade, CONTRIBUTING.md, .editorconfig. Phase 6: full local CI verification via `act push`. Phase 7: strict mypy, multi-version CI (3.11+3.12), git-lfs cleanup, document catalog design choice.

---

## [x] Track: Routing Consolidation & Pipeline Testing
- **ID:** 17_routing_and_pipeline
- **Wave:** 14
- **Complexity:** M
- **Dependencies:** 13_autopsy_fixes, 16_repo_scaffolding
- **Description:** Eliminates routing rule duplication across 5 locations. Makes _routing.yaml and _dataset.yaml the single source of truth — prompts.py and run_embeddings.py read from YAML instead of hardcoding. Adds drift detection test (CI catches when sources diverge). Adds unit tests for the entire embedding pipeline (run_embeddings.py + populate_embeddings.py, currently zero tests).

---

## [x] Track: YAML Schema Enrichment & Data Profiling
- **ID:** 18_yaml_schema_enrichment
- **Wave:** 15
- **Complexity:** L
- **Dependencies:** 17_routing_and_pipeline
- **Description:** Enriches YAML catalog with structured metadata fields (category, formula, example_values, related_columns, typical_aggregation, filterable) inspired by Snowflake Cortex Analyst. Builds BQ data profiling pipeline (APPROX_TOP_COUNT) to auto-populate example_values for categorical columns.

---

## [x] Track: Embedding Strategy & Glossary Collection
- **ID:** 19_embedding_enrichment
- **Wave:** 16
- **Complexity:** L
- **Dependencies:** 18_yaml_schema_enrichment
- **Description:** Separates retrieval signals from generation context in embedding text to fix dilution. Adds category + example_values to embedding text, keeps formula/related_columns for generation only. Creates business glossary collection in BQ (20-30 concepts: PnL variants, edge metrics, slippage decomposition). Updates vector search CTE to search both collections.

---

## [ ] Track: Few-Shot Example Expansion
- **ID:** 20_few_shot_expansion
- **Wave:** 15
- **Complexity:** M
- **Dependencies:** 17_routing_and_pipeline
- **Description:** Expands validated Q→SQL examples from 54 to 150+. Fills coverage gaps: JOINs (currently 2), exchange-specific (currently 0), categorical filtering, aggregation patterns, time patterns, edge cases. All examples pass dry-run validation and column existence checks.

---

## [ ] Track: Metric Definitions, Named Filters & Monitoring
- **ID:** 21_metrics_and_filters
- **Wave:** 16
- **Complexity:** M
- **Dependencies:** 18_yaml_schema_enrichment
- **Description:** Adds metric definitions (15-20 pre-defined business calculations) and named filters (10-15 reusable SQL WHERE fragments) to YAML catalog. Fixes circuit breaker reset bug, makes cache threshold configurable. Adds alignment scorecard test suite tracking best-practice coverage metrics.

---

## [x] Track: Metadata Population, Verification & Data Profiling
- **ID:** 22_metadata_population
- **Wave:** 17
- **Complexity:** L
- **Dependencies:** 24_metadata_extraction
- **Prerequisites:** C++ trading repo access, KPI pipeline repo access
- **Description:** Populates enrichment fields (category, typical_aggregation, filterable, example_values, comprehensive, formula, related_columns) across all 4,631 columns. Builds heuristic enrichment script + BQ data profiling pipeline. Verifies ALL existing metadata (descriptions, synonyms, formulas, business_rules) against source code. Tiered approach: human-curated for high-impact columns, heuristic for bulk, LLM-assisted for remainder.

---

## [x] Track: Source Repo Discovery & Profiling Framework
- **ID:** 23_source_repo_discovery
- **Wave:** 16
- **Complexity:** L
- **Dependencies:** 19_embedding_enrichment
- **Description:** Builds infrastructure for LLM agents to explore and document 4 source repos (CPP/protos, data-library/Go consumer, data-loader/bronze→silver, KPI/gold computation). Generates repo cards, structural indexes (proto fields, transformation mappings, KPI computations), cross-repo routing guide, and end-to-end field lineage. Uses deterministic extraction (tree-sitter, protoc, grep) for structure, LLM only for semantic enrichment. All outputs committed to `metadata/` directory.

---

## [x] Track: Metadata Extraction from Source Repos
- **ID:** 24_metadata_extraction
- **Wave:** 17
- **Complexity:** L
- **Dependencies:** 23_source_repo_discovery
- **Description:** Uses structural indexes from Track 23 to populate YAML catalog with source-grounded metadata. Extracts formulas from KPI repo, assigns categories from proto/transformation context, maps cross-layer column relationships, verifies existing descriptions against source code, fills gaps with LLM-generated descriptions validated against structural indexes. Target >95% existence ratio.

---

## [ ] Track: Metadata Validation & Drift Detection
- **ID:** 25_metadata_validation
- **Wave:** 18
- **Complexity:** M
- **Dependencies:** 24_metadata_extraction
- **Description:** Permanent validation infrastructure: YAML-vs-BQ schema comparison, YAML-vs-source-repo formula verification, example SQL column validation, routing/prompt column checks, developer-facing schema diff script. Runs in CI to catch future metadata drift and hallucination.
