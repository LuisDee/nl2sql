# Track Brief: Context Layer (Phase B)

> Generated by Architect based on `initial-plan.md`

## What This Track Delivers
This track implements the **Two-Layer Metadata** system. It loads the `dev_agent_test` schema into 8 YAML catalog files with business descriptions (Layer 1) and creates 3 BigQuery embedding tables (`schema_embeddings`, `column_embeddings`, `query_memory`) (Layer 2). It also writes and tests 30+ validated Qâ†’SQL pairs.

## Source Requirements (from initial-plan.md)
- **B.1 YAML Catalog:** Create 8 YAML files (`theodata`, `kpi_*`, `quoter_quotertrade`, `_routing`) with synonyms and business rules.
- **B.2 Example Queries:** Write and test 30+ SQL examples against `dev_agent_test`.
- **B.3 Embeddings:** SQL scripts to create `metadata` dataset, embedding model, and embedding tables.
- **B.4 Populate Embeddings:** SQL scripts to insert YAML descriptions and examples into embedding tables.
- **B.5 Vector Search:** SQL scripts to create vector indexes and test retrieval (5 test cases).

## Cross-Cutting Constraints
- **Idempotency:** Embedding generation scripts should be runnable multiple times without duplicating data (use `CREATE OR REPLACE` or `MERGE`).
- **Semantic Search:** Use BigQuery `VECTOR_SEARCH` directly.

## Interface Contracts
- **Owned:** `metadata.schema_embeddings`, `metadata.query_memory` (BigQuery tables)
- **Consumed:** `google-cloud-aiplatform` (Vertex AI Embedding Model)

## Key Design Decisions
1.  **YAML Schema:** One file per table or per dataset? -> **One per table** (as per plan) for modularity.
2.  **Embeddings:** Separate model deployment or `remote model`? -> **Remote Model** (`CREATE MODEL ... REMOTE WITH CONNECTION`) for simplicity.
3.  **Examples:** Inline in Python or YAML? -> **YAML** (`examples/kpi_examples.yaml`) for portability and embedding.

## Test Strategy
- **Unit:** Validate YAML syntax and structure.
- **Integration:** Run `09_test_vector_search.sql` and verify top-1 recall for known queries.
- **Manual:** Check embedding quality by running ad-hoc `VECTOR_SEARCH` queries.

## Complexity: Large
## Estimated Phases: 4
